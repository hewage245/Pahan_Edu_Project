<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pahana Edu - Admin Book Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; }
    .container { margin-top: 50px; }
    .card { padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white; }
    .btn-space { margin-right: 5px; }
    input.table-input { width: 100%; }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4 text-primary">Admin Book Management</h2>

  <!-- Alert container -->
  <div id="alertContainer"></div>

  <!-- Add Book Form -->
  <div class="card mb-4">
    <h5>Add New Book</h5>
    <form id="addBookForm">
      <div class="row mb-2">
        <div class="col">
          <input type="text" id="title" class="form-control" placeholder="Book Title" required>
        </div>
        <div class="col">
          <input type="text" id="category" class="form-control" placeholder="Category" required>
        </div>
        <div class="col">
          <input type="text" id="image" class="form-control" placeholder="Image URL" required>
        </div>
      </div>

      <div class="row mb-2">
        <div class="col">
          <input type="number" step="0.01" id="bookPrice" class="form-control" placeholder="Price" required>
        </div>
        <div class="col">
          <input type="number" step="0.01" id="bookDiscount" class="form-control" placeholder="Discount (%)">
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-success">Add Book</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Books Table -->
  <div class="card">
    <h5>Book List</h5>
    <table class="table table-striped table-hover mt-3" id="bookTable">
      <thead>
        <tr>
          <th>Title</th>
          <th>Category</th>
          <th>Image</th>
          <th>Price</th>
          <th>Discount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const API_URL = 'http://localhost:8080/api/books';

// Show alert
function showAlert(message, type = 'success') {
  const alertContainer = document.getElementById('alertContainer');
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.role = 'alert';
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  alertContainer.appendChild(alertDiv);
  setTimeout(() => alertDiv.remove(), 3000);
}

// Load all books
function loadBooks() {
  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('bookTable').querySelector('tbody');
      tbody.innerHTML = '';
      data.forEach(book => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', book.id);
        tr.innerHTML = `
          <td class="title">${book.title}</td>
          <td class="category">${book.category}</td>
          <td class="image"><img src="${book.image}" alt="${book.title}" style="height:50px;"></td>
          <td class="price">${book.price ?? ''}</td>
          <td class="discount">${book.discount ?? ''}</td>
          <td class="actions">
            <button class="btn btn-primary btn-space edit-btn">Edit</button>
            <button class="btn btn-danger delete-btn">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      attachRowEvents();
    })
    .catch(err => console.error(err));
}

// Add book
document.getElementById('addBookForm').addEventListener('submit', function(e){
  e.preventDefault();
  const book = {
    title: document.getElementById('title').value,
    category: document.getElementById('category').value,
    image: document.getElementById('image').value,
    price: parseFloat(document.getElementById('bookPrice').value),
    discount: parseFloat(document.getElementById('bookDiscount').value) || 0
  };
  fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(book)
  })
  .then(res => res.json())
  .then(() => {
    loadBooks();
    this.reset();
    showAlert('Book added successfully!', 'success');
  })
  .catch(err => {
    console.error('Error adding book:', err);
    showAlert('Failed to add book!', 'danger');
  });
});

// Delete book
function deleteBook(id) {
  if(confirm('Are you sure to delete this book?')) {
    fetch(`${API_URL}/${id}`, { method: 'DELETE' })
      .then(res => res.text())
      .then(() => {
        loadBooks();
        showAlert('Book deleted successfully!', 'danger');
      });
  }
}

// Attach edit/delete events
function attachRowEvents() {
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.onclick = function() {
      const tr = this.closest('tr');
      const id = tr.dataset.id;

      if(this.textContent === 'Edit') {
        tr.querySelector('.title').innerHTML = `<input type="text" class="table-input" value="${tr.querySelector('.title').textContent}">`;
        tr.querySelector('.category').innerHTML = `<input type="text" class="table-input" value="${tr.querySelector('.category').textContent}">`;
        const imgSrc = tr.querySelector('img').src;
        tr.querySelector('.image').innerHTML = `<input type="text" class="table-input" value="${imgSrc}">`;
        tr.querySelector('.price').innerHTML = `<input type="number" step="0.01" class="table-input" value="${tr.querySelector('.price').textContent}">`;
        tr.querySelector('.discount').innerHTML = `<input type="number" step="0.01" class="table-input" value="${tr.querySelector('.discount').textContent}">`;

        this.textContent = 'Save';
        this.classList.replace('btn-primary', 'btn-success');

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-secondary btn-space cancel-btn';
        cancelBtn.textContent = 'Cancel';
        tr.querySelector('.actions').appendChild(cancelBtn);

        cancelBtn.onclick = () => loadBooks();

      } else if(this.textContent === 'Save') {
        const updatedBook = {
          title: tr.querySelector('.title input').value,
          category: tr.querySelector('.category input').value,
          image: tr.querySelector('.image input').value,
          price: parseFloat(tr.querySelector('.price input').value),
          discount: parseFloat(tr.querySelector('.discount input').value) || 0
        };
        fetch(`${API_URL}/${id}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(updatedBook)
        }).then(() => {
          loadBooks();
          showAlert('Book updated successfully!', 'info');
        });
      }
    };
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.onclick = function() {
      const id = this.closest('tr').dataset.id;
      deleteBook(id);
    };
  });
}

// Initial load
loadBooks();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
